# ===== 基本设置 =====
server-name smartdns

# 服务器绑定配置（国内组：60xx 端口，海外组：70xx 端口）
bind :6053 -group china -no-speed-check -no-dualstack-selection
bind-tls :6055 -group china -no-speed-check -no-dualstack-selection
bind-https :6057 -group china -no-speed-check -no-dualstack-selection

bind :7053 -group oversea -no-speed-check -no-dualstack-selection
bind-tls :7055 -group oversea -no-speed-check -no-dualstack-selection
bind-https :7057 -group oversea -no-speed-check -no-dualstack-selection

# ===== 日志配置 =====
log-level debug
log-size 128K
log-num 1
log-file /tmp/smartdns.log  

# ===== 缓存配置 =====
cache-size 2048
cache-persist yes
cache-file /tmp/smartdns.cache
cache-checkpoint-time 1800  # 30分钟保存一次缓存
rr-ttl-min 300
rr-ttl-max 86400

# ===== 证书配置 =====
ca-file /etc/ssl/certs/ca-certificates.crt
ca-path /etc/ssl/certs/

# ===== DNS 处理策略 =====
serve-expired yes
prefetch-domain yes
force-AAAA-SOA yes
force-qtype-SOA 65
dualstack-ip-selection no
dnsmasq-lease-file /dev/null
response-mode fastest-ip  # 优先连接速度最快的 IP

# ===== 防污染加固 =====
bogus-nxdomain 0.0.0.0/8
bogus-nxdomain 10.0.0.0/8
bogus-nxdomain 172.16.0.0/12
bogus-nxdomain 192.168.0.0/16
bogus-nxdomain 169.254.0.0/16

# ip-set 配置（文件存在则启用，否则注释）
ip-set -name cloudflare-ipv4 -file /etc/smartdns/ip-set/cloudflare-ipv4.txt

# ===== 域名规则 =====
conf-file /etc/smartdns/domain-set/domains.china.smartdns.conf
conf-file /etc/smartdns/domain-set/proxy-domain-list.conf
conf-file /etc/smartdns/conf.d/anti-ad-smartdns.conf
hosts-file /etc/hosts

domain-rules /lan/ -address #
domain-rules /local/ -address #
domain-rules -c /./ -group china  # 默认走国内组，需海外解析的域名通过端口指定

address /router.lan/192.168.3.2
address /wpad.lan/#
address /invalid/#
address #6

# ===== 引导DNS配置（仅用于解析download.dnscrypt.info，防泄漏） =====
# 主引导：腾讯备用DNS（119.29.29.29，全运营商兼容）
server-tls 120.53.53.53:853 -spki-pin 5TIMjgyMhA0qmPdK+AM9LX6vNI/9EPBydh/ZXdfcYmI= -bootstrap-dns -exclude-default-group
server 119.29.29.29 -bootstrap-dns -exclude-default-group
# 备用引导：电信ISP专用DNS（202.103.24.68，电信用户优先，其他运营商备用）
server 202.103.24.68 -bootstrap-dns -exclude-default-group

# ===== 代理配置 =====
proxy-server socks5://127.0.0.1:7898 -name socks5

# 新配置：将海外组查询转发到 dnscrypt-proxy2（127.0.0.1:5353）
server 127.0.0.1:5353 -group oversea  # 无需重复代理，dnscrypt 已处理

# ===== 国内 DNS 组 =====
server-tls dot.360.cn:853 -spki-pin i9WtbILFhlaOnx0OLF9BCBZ2Wr1tisRc1YGmLHAAjQA= -group china -exclude-default-group 
server-tls 120.53.53.53:853 -spki-pin 5TIMjgyMhA0qmPdK+AM9LX6vNI/9EPBydh/ZXdfcYmI= -group china -exclude-default-group
server-https https://120.53.53.53:443/dns-query -spki-pin 5TIMjgyMhA0qmPdK+AM9LX6vNI/9EPBydh/ZXdfcYmI= -group china -exclude-default-group
server-https https://223.5.5.5:443/dns-query -spki-pin pa14rFR/bBJ25OSjCswaXu6YKWgQ2BDY5jhRRicqeik= -group china -exclude-default-group
